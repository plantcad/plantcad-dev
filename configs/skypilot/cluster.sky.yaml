# Generic plantcad-dev cluster configuration for SkyPilot
envs:
  # SkyPilot will enforce the existence of any env vars with `null` values here
  HUGGING_FACE_HUB_TOKEN: null
  WANDB_API_KEY: ""
  AWS_ACCESS_KEY_ID: ""
  AWS_SECRET_ACCESS_KEY: ""
  AWS_SESSION_TOKEN: ""
  GOOGLE_APPLICATION_CREDENTIALS: ""
  RAY_DEBUG: "legacy"

workdir: .

file_mounts:
  # Upload GCS credentials file if GOOGLE_APPLICATION_CREDENTIALS is set
  ~/.config/gcloud/application_default_credentials.json: ${GOOGLE_APPLICATION_CREDENTIALS}

setup: |
  set -e

  # Log SkyPilot environment variables
  echo "SKYPILOT_NUM_NODES: $SKYPILOT_NUM_NODES"
  echo "SKYPILOT_CLUSTER_INFO: $SKYPILOT_CLUSTER_INFO"
  echo "SKYPILOT_SETUP_NODE_IPS: $SKYPILOT_SETUP_NODE_IPS"
  echo "SKYPILOT_SETUP_NODE_RANK: $SKYPILOT_SETUP_NODE_RANK"

  # ----------------------------------------------------------------------------
  # Initialize Python environment
  # ----------------------------------------------------------------------------
  uv sync --extra gpu --extra mamba

  # ----------------------------------------------------------------------------
  # Initialize Docker
  # ----------------------------------------------------------------------------
  # Add ubuntu user to docker group to avoid needing sudo for docker commands
  # TODO: Log SkyPilot issue to see why it doesn't already do this
  sudo usermod -aG docker $USER

  # ----------------------------------------------------------------------------
  # Initialize Lambda Agent
  # ----------------------------------------------------------------------------
  SKYPILOT_CLOUD_NAME=$( \
    python -c "import json, sys; print(json.loads(sys.stdin.read())['cloud'])" \
    <<< "$SKYPILOT_CLUSTER_INFO" \
  )
  if [ "${SKYPILOT_CLOUD_NAME}" == "Lambda" ]; then
    # Install Lambda Guest Agent for VM metrics https://docs.lambda.ai/public-cloud/guest-agent/
    curl -L https://lambdalabs-guest-agent.s3.us-west-2.amazonaws.com/scripts/install.sh | sudo bash
  fi

  # ----------------------------------------------------------------------------
  # Initialize Host Environment
  # ----------------------------------------------------------------------------
  # Create local env for ssh sessions
  > ~/.env # Clear first

  # Add tokens/secrets from client env
  for var in HUGGING_FACE_HUB_TOKEN WANDB_API_KEY AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN; do
    declare -n ref=$var
    if [ -n "$ref" ]; then
      echo "$var=$ref" >> ~/.env
    fi
  done

  # Set GCS credentials path if file was uploaded
  if [ -f ~/.config/gcloud/application_default_credentials.json ]; then
    echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/.config/gcloud/application_default_credentials.json" >> ~/.env
  fi

  # Source ~/.env on login
  if ! grep -q "set -a; source ~/.env; set +a" ~/.bashrc; then
    echo "set -a; source ~/.env; set +a" >> ~/.bashrc
  fi

  # ----------------------------------------------------------------------------
  # Initialize Ray
  # ----------------------------------------------------------------------------

  # Infer Ray cluster settings from SkyPilot cluster info
  # Note that `SKYPILOT_SETUP_NODE_IPS` is ordered by node rank; see:
  # https://docs.skypilot.co/en/latest/running-jobs/environment-variables.html#environment-variables-for-setup
  RAY_SETUP_HEAD_NODE_IP=$(echo "$SKYPILOT_SETUP_NODE_IPS" | head -n1)
  RAY_SETUP_CLUSTER_NAME=$( \
    python -c "import json, sys; print(json.loads(sys.stdin.read())['cluster_name'])" \
    <<< "$SKYPILOT_CLUSTER_INFO" \
  )

  # Set GCS credentials path for Ray if file was uploaded
  GCS_CREDS_PATH=""
  if [ -f ~/.config/gcloud/application_default_credentials.json ]; then
    GCS_CREDS_PATH="$HOME/.config/gcloud/application_default_credentials.json"
  fi

  # Initialize Ray cluster in sanitized environment
  env -i \
    HOME="$HOME" \
    RAY_SETUP_HEAD_NODE_IP="$RAY_SETUP_HEAD_NODE_IP" \
    RAY_SETUP_NODE_RANK="$SKYPILOT_SETUP_NODE_RANK" \
    RAY_SETUP_CLUSTER_NAME="$RAY_SETUP_CLUSTER_NAME" \
    RAY_DEBUG="$RAY_DEBUG" \
    HUGGING_FACE_HUB_TOKEN="$HUGGING_FACE_HUB_TOKEN" \
    AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID" \
    AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY" \
    AWS_SESSION_TOKEN="$AWS_SESSION_TOKEN" \
    GOOGLE_APPLICATION_CREDENTIALS="$GCS_CREDS_PATH" \
    bash --login scripts/ray_init.sh
